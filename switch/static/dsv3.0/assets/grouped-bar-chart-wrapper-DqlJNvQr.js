import{r as p,g as u,i as d,a as l,j as h}from"./index-C2PWchud.js";import{B as x}from"./base-element-5lxvCIHt.js";import"./transform-C4D8YA0C.js";import{m as g,l as b,a as y,b as f}from"./linear-B99wrUbv.js";import{b as c}from"./band-BugeWyNR.js";import{o as v}from"./ordinal-CG2fZEFB.js";import{u as _}from"./utils-mixin-D5aAiqNi.js";import{t as C}from"./defaultLocale-CUWc-s_R.js";import{s as r}from"./value-_r9_x9JY.js";import{m as n}from"./mouse-zJOo7xoE.js";import{C as S}from"./chart-mixin-ykJDgLsu.js";import{C as L}from"./chart-mixin-styles-css-ChS978uy.js";import{w}from"./datasource-mixin-DMQBE4lo.js";import"./array-UnU61Zeg.js";import"./calendar-element-C00wmKBV.js";import"./select-element-GuC7mP6J.js";import"./InputMixin-CGm-oGk-.js";const j=class extends _(x){static get properties(){return{groups:Array,subGroups:Array,filters:Object,chart:Object,svg:Object,svgCanvas:Object,width:Number,height:Number,margin:Object,x_axis:Object,y_axis:Object,x_scale:Object,x_scale2:Object,y_scale:Object,colorScale:Object,x_axisElement:Object,y_axisElement:Object,filtersElement:Object,x_axisLabelElement:Object,y_axisLabelElement:Object,x_axisLabel:String,y_axisLabel:String,slice:Object,bars:Object,colors:Array,tooltip:Object,chartTitle:Object,details:Object,legendColor:Object,legendKey:Object,dateRange:Object,calenderToggler:String}}constructor(){super(),this.groups=[],this.subGroups=[],this.chartData=[]}firstUpdated(t){super.firstUpdated(t),this.chart=this.shadowRoot.querySelector("#chart"),console.log("this bar chaty ",this.e),this.loader=this.chartSummaryLoader?this.chartSummaryLoader:this.loader,this.details=this.chartSummaryDetails?this.chartSummaryDetails:this.e.details,this.timeFormat=this.e.details.time_format?this.e.details.time_format:"%d %b",this.cols=this.chartSummaryCols?this.chartSummaryCols:this.cols,this.rows=this.chartSummaryRows?this.chartSummaryRows:this.rows,this.createChartData(),this.x_axisLabel=this.details.x_axisLabel,this.y_axisLabel=this.details.y_axisLabel,this.initGroupedBarChart(),new ResizeObserver(()=>this.drawGroupedBarChart()).observe(this.chart)}updated(t){super.updated(t),t.forEach((a,s)=>{s==="rows"&&a&&a.length>0&&(this.createChartData(),this.updateChart(),this.drawGroupedBarChart())})}createGroups(){const t=[];this.rows.forEach(a=>{let s=a[this.getIndexByColumnLabel("group")];t.includes(s)||(this.isColumnLabelTypeDateTime("group")&&(s=C(this.timeFormat)(new Date(s))),t.push(s),this.groups=[...this.groups,s])})}createChartData(){this.createGroups(),this.subGroups=this.details.columns_to_plot?this.details.columns_to_plot:[],this.colors=this.subGroups.map((t,a,s)=>this.randomColorGenerator(s.length,a)),this.chartData=[],this.groups.forEach((t,a)=>{let s={group:t};this.subGroups.forEach(e=>s={...s,[e]:this.rows[a][this.getIndexByColumnLabel(e)]}),this.chartData=[...this.chartData,s]}),this.legend=this.subGroups.map((t,a)=>{const s=this.colors[a];return{label:this.toTitleCase(t),color:s}})}getIndexByColumnLabel(t){return this.cols.findIndex(a=>a.label.toLowerCase()===t.toLowerCase())}initGroupedBarChart(){this.createSVGs(),this.createScales(),this.createAxes(),this.updateChart(),this.createToolTip(),this.drawGroupedBarChart()}calculateMargin(){let s=5,e=15;if(this.chartData){const i=this.svg.append("text").text(g(this.groups)),o=this.svg.append("text").text(this.maxYAxisValue());s=o.node().getComputedTextLength()+s,e=i.node().getComputedTextLength()+e,i.remove(),o.remove()}this.margin={top:40,right:25,bottom:e,left:s}}calculateSvgDimensions(){this.calculateMargin();const t=e=>{const i=Math.max(document.documentElement.clientHeight,window.innerHeight||0);return e*i/100},a=this.chart.getBoundingClientRect().width-this.margin.left,s=t(this.details.height?this.details.height:50)-this.margin.bottom;this.width=a,this.height=s}createScales(){this.x_scale=c(),this.x_scale2=c(),this.y_scale=b(),this.colorScale=v()}createAxes(){this.x_axis=y(this.x_scale),this.y_axis=f(this.y_scale),this.x_axisElement=this.svgCanvas.append("g").attr("transform",`translate(0,${this.height})`),this.y_axisElement=this.svgCanvas.append("g").attr("transform","translate(0,0)"),this.x_axisLabelElement=this.svgCanvas.append("text").attr("text-anchor","middle").attr("fill","var(--grey-dark)").text(`${this.x_axisLabel}`),this.y_axisLabelElement=this.svgCanvas.append("text").attr("text-anchor","middle").attr("fill","var(--grey-dark)").attr("transform","rotate(-90)").text(`${this.y_axisLabel}`)}maxYAxisValue(){let t=0;return this.rows.forEach(a=>{this.subGroups.forEach(s=>{const e=a[this.getIndexByColumnLabel(s)];e>t&&(t=e)})}),t}updateChart(){this.x_scale.domain(this.groups),this.x_scale2.domain(this.subGroups),this.y_scale.domain([0,this.maxYAxisValue()]),this.colorScale.domain(this.subGroups).range(this.colors),this.createSlice(),this.createBars()}createSlice(){this.slice&&this.slice.remove(),this.slice=this.svgCanvas.selectAll("slice").data(this.chartData).join("g").attr("class","g")}createBars(){this.bars&&this.bars.remove();const t=(s,e,i)=>{this.tooltip.transition().duration(200).style("opacity",.9),r(i[e]).style("opacity","0.6"),this.tooltip.html(`${this.x_axisLabel}: ${s.key}<br/>${this.y_axisLabel}: ${s.value}`).style("left",n(this)[0]+70+"px").style("top",n(this)[1]+"px")},a=(s,e,i)=>{this.tooltip.transition().duration(500).style("opacity",0),r(i[e]).style("opacity","1")};this.bars=this.slice.selectAll("rect").data(s=>this.subGroups.map(e=>({key:e,value:s[e]}))).join("rect").style("fill",s=>this.colorScale(s.key)).style("cursor","pointer").style("ry","5").on("mouseover",(s,e,i)=>t(s,e,i)).on("mouseout",(s,e,i)=>a(s,e,i))}createSVGs(){this.svg=r(this.chart).append("svg").attr("preserveAspectRatio","xMinYMin meet"),this.svgCanvas=this.svg.append("g"),this.calculateSvgDimensions()}createToolTip(){this.tooltip=r(this.chart).append("div").attr("class","tooltip").style("opacity",0)}drawGroupedBarChart(){this.calculateSvgDimensions(),this.responsiveSVG(),this.responsiveSVGCanvas(),this.responsiveScale(),this.responsiveYTicks(),this.responsiveAxes(),this.responsiveSlice(),this.responsiveBars()}responsiveSVG(){this.svg.attr("width",this.width+this.margin.left),this.svg.attr("height",this.height+this.margin.bottom)}responsiveSVGCanvas(){this.svgCanvas.attr("transform",`translate(${this.margin.left}, 0)`)}responsiveScale(){this.x_scale.range([0,this.width]).padding(.2),this.x_scale2.range([0,this.x_scale.bandwidth()]).padding(.1),this.y_scale.range([this.height,0]),this.x_axis.scale(this.x_scale),this.y_axis.scale(this.y_scale)}responsiveYTicks(){this.y_axis.tickSize(-this.width).tickFormat(t=>t)}responsiveAxes(){this.x_axisElement.call(this.x_axis),this.y_axisElement.call(this.y_axis),this.styleAxesElements(),this.y_axisLabelElement.attr("y",-this.margin.left+13).attr("x",-this.height/2),this.x_axisLabelElement.attr("x",this.width/2).attr("y",this.height+(this.margin.bottom-15))}responsiveSlice(){this.slice.attr("transform",t=>`translate(${this.x_scale(t.group)},0)`)}responsiveBars(){this.bars.attr("x",t=>this.x_scale2(t.key)).attr("width",this.x_scale2.bandwidth()).attr("y",t=>this.y_scale(t.value)).attr("height",t=>this.height-this.y_scale(t.value))}styleAxesElements(){this.y_axisElement.call(t=>t.select(".domain").remove()).call(t=>t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.05)).call(t=>t.selectAll("text").attr("x",-7)),this.x_axisElement.attr("transform",`translate(0,${this.height})`).call(t=>t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.3)).call(t=>t.selectAll("text").attr("y",0).attr("x",9).attr("dy",".35em").attr("transform","rotate(60)").style("text-anchor","start"))}toTitleCase(t){if(!t)return"";t=t.toString(),t=t.toLowerCase().split(" ");let a=[];for(let s=0;s<t.length;s++)a[s]=t[s].substr(0,1).toUpperCase()+t[s].substr(1);return a.join(" ")}isColumnLabelTypeDateTime(t){return this.cols[this.getIndexByColumnLabel(t)].type==="datetime"}dscDataName(){return this.e.defaultValue}static get is(){return"grouped-bar-chart"}init(t,a){super.init(t,a);var s=this;s.loader=this.loadData()}};let m=class extends S(j){static get styles(){return[p(u),L,d`
                :host {
                    display: block;
                }
            `]}};customElements.define(m.is,m);const G=({element:t,data:a,rows:s})=>{const e=l.useRef(null);return l.useEffect(()=>{e.current&&s&&(e.current.rows=s,e.current.e=t)},[s]),h.jsx("div",{children:t&&a&&s?h.jsx("grouped-bar-chart",{ref:e}):h.jsx("p",{children:"Loading data..."})})},W=w(G);export{W as default};
